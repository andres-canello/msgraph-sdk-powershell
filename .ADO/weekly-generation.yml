# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
pool: MsGraphDevXAzureAgents

variables:
  BranchDate: "$[format('{0:yyyyMMdd}', pipeline.startTime)]"
  Branch: 'testweeklyOpenApiDocsDownload/$(BranchDate)'
  BaseBranch: 'dev'
  BUILDNUMBER: -1

schedules:
- cron: "0 12 * * WED" # Run every wednesday at noon UTC
  displayName: "Weekly SDK Generation"
  branches: 
    include:
    - dev
  always: true

stages:
  # Run checkout stage.
  - stage: DownloadOpenAPIDocs
    displayName: 'Download OpenAPI Docs'
    jobs:
    - template: common-templates/download-openapi-docs-stage.yml
      parameters:
        Branch: $(Branch)
        BaseBranch: $(BaseBranch)

  - stage: GenerateServiceModules
    displayName: Generate Service Modules
    variables:
      ModulesToGenerate: $[ stageDependencies.DownloadOpenAPIDocs.GetLatestDocs.outputs['OpenAPIDocDiff.ModulesWithChanges'] ]
    jobs:
      - template: generation-templates/generate-service-modules.yml
        parameters:
          ModulesWithChanges: $(ModulesToGenerate)
          MODULE_PREFIX: $(MODULE_PREFIX)
          EnableSigning: true
          BUILDNUMBER: $(BUILDNUMBER)
          CHECKOUT_BRANCH: $(Branch)


  # Git diff on download OpenAPI docs. Store changed modules in a variable.
  # Commit downloaded docs.
  # If modules change, bump their minor and meta-module version.
  # Generate changed modules + run tests.
  # Commit generated files to weekly branch.
  # Create PR to dev